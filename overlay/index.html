<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;700&display=swap" rel="stylesheet">
  <style>
  html, body {
    width: 1920px;
    height: 1080px;
  }
  body {
    margin: 0;
    background: transparent;
    overflow: hidden;
    font-weight: 400; /* Ustawienie domyślnej grubości dla body */
    font-family: 'Rajdhani', sans-serif;
  }
  @keyframes pulseRed {
    0%, 100% { background: #a60000; }
    50% { background: #ff0000; }
  }
  #overlay-bar {
    position: fixed;
    bottom: 0;
    width: 770px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(to right, rgba(188, 33, 48, 0) 0%, #bc2130 15%, #bc2130 85%, rgba(188, 33, 48, 0) 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1.2px 9.6px;
    color: white;
    flex-direction: column;
  }
  .player-line {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    gap: 30px;
  }
  .player {
  display: flex;
  align-items: center;
  gap: 14.4px; /* Zwiększona przerwa od cyfr */
  font-size: 20px; /* Większa czcionka */
}

.player span {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
    /* Imię będzie miało domyślną grubość (400 od body) */
}

.player span strong {
  font-weight: 700; /* Nazwisko (wewnątrz strong) będzie miało grubość 700 */
}

.player img {
  width: 28px; /* Większa flaga */
  height: 20px;
  object-fit: contain;
}
  .score-box {
    display: flex;
    gap: 7.2px;
    font-size: 24px;
    font-weight: bold;
    z-index: 2;
    justify-content: center;
  }
  .score-box .score {
    background: #a80b1b;
    padding: 2.4px 9.6px;
    border-radius: 4.8px;
    transition: background-color 0.5s ease-in-out; /* Zmienione dla płynniejszego przejścia koloru tła */
  }
  .score-box .score.score-highlight {
    animation: none !important; /* Zatrzymuje inne animacje (np. pulseRed) na czas podświetlenia */
    background-color: #FFD700 !important; /* Wymusza żółte tło, !important dla pierwszeństwa */
    /* Opcjonalnie: zmiana koloru tekstu dla lepszego kontrastu na żółtym tle, np. color: #333; */
  }
    .score-box .score.score-win {
    background-color: #FFD700 !important; /* Żółte tło */
    color: black !important;             /* Czarny kolor tekstu */
    animation: none !important;          /* Zatrzymuje inne animacje (pulseRed, score-highlight) */
  }
  .score-box.decisive .score {
    animation: pulseRed 4s infinite;
  }
  .decor-line {
    width: 100%;
    height: 2px;
    background: linear-gradient(to right, transparent 0%, white 50%, transparent 100%);
    margin: 3px 0;
  }
  #raceToText {
    font-size: 14.4px;
    margin-top: 1.2px;
  }
  .corner-logo {
    position: fixed;
    z-index: 3;
  }
 /* Nowy kontener dla lewego logo i tekstu stołu */
  #logoLeftArea {
    top: 20px;
    left: 60px;
    display: flex;
    flex-direction: column;
    align-items: center; /* Wyśrodkowuje elementy wewnątrz (logo i tekst) */
    gap: 8px; /* Odstęp między logo a tekstem stołu */
  }

  #logoLeftArea #logoLeft { /* Styl dla samego obrazka logo wewnątrz kontenera */
    height: 128px; /* Zmniejszone o 20% (było 160px) */
    width: auto;
  }
  #logoRight {
    top: 20px;
    right: 30px;
    width: 150px;
    height: 150px;
  }
  #tableText {
    /* Usunięto position: fixed, top, left, transform - teraz jest pozycjonowany przez flexbox */
    font-size: 24px;
    font-weight: bold;
    text-align: center;
    color: white;
    text-shadow: 1px 1px 4px black;
    margin-left: -10px; /* Dodatkowe przesunięcie w prawo o 20px */
     }
  #watermark {
    position: absolute;
    bottom: 2px; /* Niewielki odstęp od dolnej krawędzi paska */
    right: -150px;
    font-size: 12px; /* Nieco większa czcionka (było 10px) */
    color: rgba(255, 255, 255, 0.8); /* Biały z przezroczystością dla subtelnego efektu */
    z-index: 1; /* Aby być pod innymi elementami, jeśli nachodzą */
      }
  #playerMatchHistoryContainer {
    position: fixed;
    top: calc(20px + 150px + 10px); /* Positioned below logoRight (top + height + gap) */
    right: 10px; /* Aligns with logoRight's right edge */
    width: 220px; /* Adjust width as needed */
    background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent background */
    color: white;
    font-family: 'Rajdhani', sans-serif;
    font-size: 13px;
    padding: 8px;
    border-radius: 4px;
    z-index: 3; /* Ensure it's above the main bar if overlapping */
    display: none; /* Initially hidden */
  }
  #playerMatchHistoryTitle {
    font-weight: 700; /* Bold */
    margin-bottom: 6px;
  }
  #playerMatchHistoryList div { /* Each match entry */
    margin-bottom: 4px;
  }
</style>
</head>
<body>
  <!-- Zmieniona struktura dla lewego logo i tekstu stołu -->
  <div id="logoLeftArea" class="corner-logo">
    <img id="logoLeft" src="austrian_open.png" alt="Austrian Open">
    <div id="tableText">Table</div>
  </div>
  <img id="logoRight" class="corner-logo" src="logo_muklacademy_polysk_alpha.png" alt="MuklAcademy">
    <!-- Container for Player Match History -->
  <div id="playerMatchHistoryContainer">
    <div id="playerMatchHistoryTitle"></div>
    <div id="playerMatchHistoryList"></div>
  </div>

  <div id="overlay-bar">
    <div class="decor-line"></div>
    <div class="player-line">
      <div class="player" id="leftPlayer">
        <img id="leftFlag" src="" alt="flag1">
        <span id="player1">Player 1</span>
      </div>
      <div class="score-box" id="scoreBox">
        <span class="score" id="score1">0</span>
        <span class="dash">-</span>
        <span class="score" id="score2">0</span>
      </div>
      <div class="player" id="rightPlayer">
        <span id="player2">Player 2</span>
        <img id="rightFlag" src="" alt="flag2">
      </div>
    </div>
    <div class="decor-line"></div>
    <div id="raceToText">Race to 0</div>
        <div id="watermark">Overlay by Muklacademy/MarcinKwiecien</div>

  </div>

  <script>
        // Zmienne do przechowywania poprzednich wyników i ID timerów dla animacji
    let previousScore1 = undefined;
    let previousScore2 = undefined;
    let score1TimeoutId = null;
    let score2TimeoutId = null;
        // DEFINE THE PLAYER ID YOU WANT TO TRACK HISTORY FOR
    // Example: For Wojciech Szewczyk on Eurotour 1334, ID is '131'
    const PLAYER_ID_TO_TRACK = '131'; // << CHANGE THIS TO THE DESIRED PLAYER ID

    async function updateOverlay() {
      function formatPlayerNameForDisplay(fullName) {
        if (!fullName || typeof fullName !== 'string') {
          return '';
        }
        // Podziel na słowa, usuwając puste wpisy (np. po wielokrotnych spacjach)
        const words = fullName.trim().split(' ').filter(word => word.length > 0);
        if (words.length === 0) {
          return '';
        }
   let resultHtml = '';
        let inStrongTag = false;

        for (let i = 0; i < words.length; i++) {
          const word = words[i];
          // Słowo jest częścią nazwiska do pogrubienia, jeśli:
          // 1. Jest całe wielkimi literami.
          // 2. Zawiera przynajmniej jedną literę (aby odróżnić od np. "-").
          // 3. Nie jest czysto numeryczne (np. "1990").
          const isSurnamePart = word === word.toUpperCase() &&
                                /[A-Z]/.test(word) &&
                                !/^\d+$/.test(word);

          if (isSurnamePart) {
            if (!inStrongTag) {
              resultHtml += (resultHtml.length > 0 ? ' ' : '') + '<strong>';
              inStrongTag = true;
            } else {
              resultHtml += ' '; // Spacja między kolejnymi częściami nazwiska w <strong>
            }
            resultHtml += word;
          } else { // To jest imię lub inna część nie do pogrubienia
            if (inStrongTag) {
              resultHtml += '</strong>';
              inStrongTag = false;
            }
            resultHtml += (resultHtml.length > 0 ? ' ' : '') + word;
          }
        }
        if (inStrongTag) {
          resultHtml += '</strong>'; // Zamknij tag, jeśli ostatnie słowo było częścią nazwiska
        }
        return resultHtml;
      }

      try {
        let fetchUrl = "https://epbf-overlay-backend-production.up.railway.app/score";
        if (PLAYER_ID_TO_TRACK) {
          fetchUrl += `?playerId=${PLAYER_ID_TO_TRACK}`;
        }
        const res = await fetch(fetchUrl);
        const data = await res.json();

        const score1El = document.getElementById('score1');
        const score2El = document.getElementById('score2');
        const newScore1 = data.score1;
        const newScore2 = data.score2;

        // Aktualizacja wyświetlanych wyników
        score1El.innerText = newScore1;
        score2El.innerText = newScore2;

        // Animacja dla wyniku gracza 1
        if (previousScore1 !== undefined && previousScore1 !== newScore1) {
          if (score1TimeoutId) clearTimeout(score1TimeoutId);
          score1El.classList.add('score-highlight');
          score1TimeoutId = setTimeout(() => {
            score1El.classList.remove('score-highlight');
            score1TimeoutId = null;
          }, 2000);
        }

        // Animacja dla wyniku gracza 2
        if (previousScore2 !== undefined && previousScore2 !== newScore2) {
          if (score2TimeoutId) clearTimeout(score2TimeoutId);
          score2El.classList.add('score-highlight');
          score2TimeoutId = setTimeout(() => {
            score2El.classList.remove('score-highlight');
            score2TimeoutId = null;
          }, 2000);
        }

        document.getElementById('player1').innerHTML = formatPlayerNameForDisplay(data.player1);
        document.getElementById('player2').innerHTML = formatPlayerNameForDisplay(data.player2);
        document.getElementById('leftFlag').src = data.flag1;
        document.getElementById('rightFlag').src = data.flag2;
        document.getElementById('raceToText').innerText = `Race to ${data.raceTo}`;
        document.getElementById('tableText').innerText = `Table ${data.table}`;

        const scoreBox = document.getElementById('scoreBox');
        const s1 = parseInt(data.score1);
        const s2 = parseInt(data.score2);
        const race = parseInt(data.raceTo);

// Sprawdzenie warunku wygranej
        const p1Wins = !isNaN(s1) && !isNaN(race) && s1 === race;
        const p2Wins = !isNaN(s2) && !isNaN(race) && s2 === race;

        if (p1Wins) {
          score1El.classList.add('score-win');
          score2El.classList.remove('score-win');
          scoreBox.classList.remove('decisive'); 
        } else if (p2Wins) {
          score2El.classList.add('score-win');
          score1El.classList.remove('score-win');
          scoreBox.classList.remove('decisive');
        } else {
          score1El.classList.remove('score-win');
          score2El.classList.remove('score-win');
          if (!isNaN(s1) && !isNaN(s2) && !isNaN(race) && (s1 === race - 1 && s2 === race - 1)) {
            scoreBox.classList.add('decisive');
          } else {
            scoreBox.classList.remove('decisive');
          }
        }
                // Populate player match history
        const historyContainer = document.getElementById('playerMatchHistoryContainer');
        const historyTitleEl = document.getElementById('playerMatchHistoryTitle');
        const historyListEl = document.getElementById('playerMatchHistoryList');

        if (data.playerHistory && data.playerHistory.length > 0) {
          historyTitleEl.innerText = "Last matches:";
          historyListEl.innerHTML = ''; // Clear previous entries
          data.playerHistory.forEach(matchStr => {
            const matchDiv = document.createElement('div');
            const colonIdx = matchStr.indexOf(':');
            if (colonIdx !== -1) {
              const round = matchStr.slice(0, colonIdx).trim();
              const text = matchStr.slice(colonIdx + 1).trim();
              matchDiv.innerHTML = `<strong>${round}</strong>: ${text}`;
            } else {
              matchDiv.innerText = matchStr;
            }

            historyListEl.appendChild(matchDiv);
          });
          historyContainer.style.display = 'block';
        } else {
          historyContainer.style.display = 'none';
          historyTitleEl.innerText = ""; // Clear title if no history
          historyListEl.innerHTML = ''; // Clear list if no history
        }
        previousScore1 = newScore1;
        previousScore2 = newScore2;

      } catch (e) {
        console.error("Failed to update overlay", e);
                // Optionally hide history on error
        const historyContainer = document.getElementById('playerMatchHistoryContainer');
        if (historyContainer) historyContainer.style.display = 'none';
      }
    }

    updateOverlay();
    setInterval(updateOverlay, 5000);
  </script>
</body>
</html>
    